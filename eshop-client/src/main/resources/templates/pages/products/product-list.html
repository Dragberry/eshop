<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layouts/template-with-breadcrumb}">
<head>
<title th:text="${category} ? ${category.name} : #{msg.common.allProducts}">Catalog</title>
</head>
<body>
	<th:block layout:fragment="main-content">
		<div class="col-md-3">
			<div class="container">
				<div class="row">
					<th:block th:replace="pages/products/categories-side-menu :: categories-side-menu(selectedCategory = ${selectedCategory})"></th:block>
				</div>
				<div th:if="${selectedCategory}" class="row mt-2">
					<button class="btn btn-block btn-secondary btn-sm btn-side-menu" type="button" data-toggle="collapse"
						data-target="#filtersForm" aria-expanded="false" aria-controls="filtersForm">
						<span th:text="#{msg.common.filters}">Filters</span>
					</button>
					<div class="content-side-menu collapse show">
						<form id="filtersForm" th:action="|${@environment.getProperty('url.catalog.filter')}/${selectedCategory}|" method="GET">
							<th:block th:each="filter : ${category.filters}">
								<th:block th:replace="__${filter.template}__"></th:block>
								<hr/>
							</th:block>
						</form>
					</div>
				</div>	
			</div>
		</div>
		<div class="col-md-9">
			<div class="row">
				<div class="col-12 col-xs-12 col-sm-6 col-md-8">
					<h1 th:text="${category} ? ${category.name} : #{msg.common.allProducts}"></h1>
				</div>
				<div class="col-12 col-xs-12 col-sm-6 col-md-4">
					<div class="input-group">
	    				<div class="input-group-prepend">
					    	<div class="input-group-text">
					    		<span class="fa fa-sort fa-xs" th:title="#{msg.common.sorting}"></span>
					    	</div>
					    </div>
	    				<select form="filtersForm" name="sort" class="form-control form-control-sm" id="sorting" onchange="doSearch()">
							<option th:each="opt : ${sortingOptionList}" th:value="${opt.value}" th:text="#{${opt.key}}"></option>
						</select>
					</div>
				</div>
			</div>
			<div th:fragment="products" id="productList" class="row card-columns">
				<div th:each="productItem : ${productList}" class="col-sm-6 col-md-6 col-lg-4 col-xl-4">
					<div th:replace="pages/products/product-list-item :: product-list-item(product = ${productItem})">Product item</div>
				</div>
			</div>
		</div>
	</th:block>
	<th:block layout:fragment="page_scripts">
		<script>
			var delayTimer;
			function doSearch() {
				clearTimeout(delayTimer);
				delayTimer = setTimeout(function() {
					var form = $('#filtersForm');
				    var url = form.attr('action');
				    $.ajax({
				    	type: "GET",
				        url: url,
				        data: form.serialize(),
				        success: function(data)  {
				        	$('#productList').fadeOut('normal', function() {
				        		$(this).replaceWith(data);
				        		calculateRatings();
				        		updateCommentsCount();
				        	});
				        }
				   	});
				}, 1000);
			}
		</script>
	</th:block>
</body>
</html>