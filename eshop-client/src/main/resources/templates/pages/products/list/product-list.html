<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layouts/template-with-breadcrumb}">
<head>
<title th:text="${category} ? ${category.name} : #{msg.common.allProducts}">Catalog</title>
</head>
<body>
	<th:block layout:fragment="main-content">
		<div class="col-md-3">
			<div class="container">
				<div class="row">
					<th:block th:replace="pages/products/list/categories-side-menu :: categories-side-menu(selectedCategory = ${selectedCategory})"></th:block>
				</div>
				<form th:if="${selectedCategory}" id="filtersForm" th:action="|${@environment.getProperty('url.catalog.filter')}/${selectedCategory}|" method="GET">
					<div class="row mt-2">
						<div class="w-100 text-center">
							<button class="btn btn-block btn-secondary btn-sm btn-side-menu" type="button" data-toggle="collapse"
								data-target="#filters" aria-expanded="false" aria-controls="filters">
								<span th:text="#{msg.common.filters}">Filters</span>
								<span class="all-filters-count badge badge-dark"
									th:classappend="${searchParamsCount == 0} ? 'd-none' : ''"
									th:text="${searchParamsCount}"></span>
							</button>
							<button class="all-filters-reset-button btn btn-link" 
								th:classappend="${searchParamsCount == 0} ? 'd-none' : ''"
								type="button" onclick="resetForm()">
								<span class="small" th:text="#{msg.common.resetAllFilter}">Reset</span>
							</button>
						</div>
						<div id="filters" class="content-side-menu collapse show">
							<th:block th:each="filter : ${category.filters}">
								<th:block th:replace="__${filter.template}__"></th:block>
								<hr/>
							</th:block>
						</div>
					</div>	
				</form>
				<form th:unless="${selectedCategory}" id="filtersForm" th:action="|${@environment.getProperty('url.catalog.filter')}|" method="GET">
				</form>
			</div>
		</div>
		<div class="col-md-9">
			<div class="row mb-4">
				<div class="col-12">
					<h1 th:text="${category} ? ${category.name} : #{msg.common.allProducts}"></h1>
				</div>
				<div class="col-12">
					<div class="form-row d-flex justify-content-end">
						<div class="col-6 col-sm-4 col-md-3">
							<div class="input-group d-flex justify-content-end">
								<div class="form-check form-check-inline list-display-type">
								  	<label class="btn" for="displayTiles"
								  		th:classappend="${#strings.equals(displayOption, 'TILES') ? 'btn-secondary' : ''}">
								  		<input form="filtersForm"
								  			id="displayTiles" 
								  			type="radio"
								  			name="display"
								  			value="tiles"
								  			class="form-check-input"
								  			onchange="onDisplayChanged();doFilter()"
								  			th:checked="${#strings.equals(displayOption, 'TILES')}">
							 			<span class="fa fa-table"></span>
								  	</label>
								</div>
								<div class="form-check form-check-inline list-display-type">
								  	<label class="btn" for="displayList"
								  		th:classappend="${#strings.equals(displayOption, 'LIST') ? 'btn-secondary' : ''}">
								  		<input form="filtersForm"
								  			id="displayList" 
								  			type="radio"
								  			name="display"
								  			value="list"
								  			class="form-check-input"
								  			onchange="onDisplayChanged();doFilter()"
								  			th:checked="${#strings.equals(displayOption, 'LIST')}">
								  		<span class="fa fa-list"></span>
								  	</label>
								</div>
							</div>
						</div>
						<div class="col-6 col-sm-6 col-md-5">
							<div class="input-group">
			    				<div class="input-group-prepend">
							    	<div class="input-group-text">
							    		<span class="fa fa-sort fa-xs" th:title="#{msg.common.sorting}"></span>
							    	</div>
							    </div>
			    				<select form="filtersForm" name="sort" class="form-control form-control-sm" id="sorting" onchange="doFilter()">
									<option th:each="opt : ${sortingOptionList}" 
										th:value="${opt.value}"
										th:selected="${searchParams.get('sort') != null ? searchParams.get('sort')[0] == opt.value : false}"
										th:text="#{${opt.key}}"></option>
								</select>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div th:fragment="products" id="productList" class="row card-columns">
				<th:block th:each="productItem : ${productList}">
					<div th:replace="__${displayOption.template}__">Product item</div>
				</th:block>
			</div>
		</div>
	</th:block>
	<th:block layout:fragment="page_scripts">
		<script>
			function onDisplayChanged() {
				$('input[name="display"]').parent().removeClass('btn-secondary');
				$('input[name="display"]:checked').parent().addClass('btn-secondary');
			}
		
			var delayTimer;
			function doFilter() {
				countFilters();
				clearTimeout(delayTimer);
				delayTimer = setTimeout(function() {
					var form = $('#filtersForm');
				    var url = form.attr('action');
				    $.ajax({
				    	type: "GET",
				        url: url,
				        data: form.serialize(),
				        success: function(data)  {
				        	$('#productList').fadeOut('normal', function() {
				        		$(this).replaceWith(data);
				        		calculateRatings();
				        		updateCommentsCount();
				        	});
				        }
				   	});
				}, 1000);
			}
			
			function resetForm() {
				document.getElementById('filtersForm').reset()
				$('#filtersForm input[type="text"]').val('');
				$('#filtersForm input[type="checkbox"]').attr('checked', false);
				$('#sorting').prop('selectedIndex', 0);
				doFilter();
			}
			
			function countFilters() {
				var count = $('#filtersForm input[type="text"]').filter(function() {
				    return this.value;
				}).length + $('#filtersForm input[type="checkbox"]:checked').length;
				if (count == 0) {
					$('.all-filters-count').addClass('d-none').text(0);
					$('.all-filters-reset-button').addClass('d-none');
				} else {
					$('.all-filters-count').removeClass('d-none').text(count);
					$('.all-filters-reset-button').removeClass('d-none');
				}
			}
		</script>
	</th:block>
</body>
</html>